<!-- Styles -->
<style>
    #chardiv-tab-pane {
        width: 100%;
        height: 600px;
        max-width: 100%;
    }
</style>

<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>

<!-- Chart code -->
<script>

    var root
    am5.ready(function () {
        root = am5.Root.new("chardiv-tab-pane");
    });

    function chartDraw(data, symbol, timeUnit) {
        root.dispose();
        root = am5.Root.new("chardiv-tab-pane");
        root.setThemes([
            am5themes_Dark.new(root)
        ]);

        root.numberFormatter.set("numberFormat", "#,###.#########");
        // Create a stock chart
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/stock-chart/#Instantiating_the_chart
        var stockChart = root.container.children.push(am5stock.StockChart.new(root, {

            stockPositiveColor: am5.color(0x318866),
            stockNegativeColor: am5.color(0x9a5760),
            volumePositiveColor: am5.color(0x7ec6de),
            volumeNegativeColor: am5.color(0x7ec6de),

        }));
        // var chart = root.container.children.push(
        //     am5xy.XYChart.new(root, {
        //         panX: true,
        //         panY: false,
        //         wheelX: "panX",
        //         wheelY: "zoomX",
        //         layout: root.verticalLayout,
        //         pinchZoomX: true,
        //     })
        // );

        // Create a main stock panel (chart)
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/stock-chart/#Adding_panels
        var mainPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
            wheelY: "zoomX",
            panX: true,
            panY: true
        }));




        // Create value axis
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var valueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {
                pan: "zoom"
            }),
            extraMin: 0.1, // adds some space for for main series
            tooltip: am5.Tooltip.new(root, {}),
            numberFormat: "#,###.00",
            extraTooltipPrecision: 2
        }));

        // Create date Axis
        var dateAxis = mainPanel.xAxes.push(am5xy.GaplessDateAxis.new(root, {
            baseInterval: {
                timeUnit: timeUnit,
                count: 1
            },
            renderer: am5xy.AxisRendererX.new(root, {}),
            tooltip: am5.Tooltip.new(root, {})
        }));



        // Create series OHLC ----------------------------------------------------------------------
        var valueSeries = mainPanel.series.push(
            am5xy.CandlestickSeries.new(root, {
                name: symbol,
                xAxis: dateAxis,
                yAxis: valueAxis,
                clustered: false,
                openValueYField: "o",
                highValueYField: "h",
                lowValueYField: "l",
                valueYField: "c",
                valueXField: "dt",
                calculateAggregates: true,
                legendValueText: "o: [bold]{openValueY}[/] h: [bold]{highValueY}[/] l: [bold]{lowValueY}[/] c: [bold]{valueY}[/]",
                legendRangeValueText: ""
            })
        );

        // Set main value series
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/stock-chart/#Setting_main_series
        stockChart.set("stockSeries", valueSeries);

        // Add a stock legend
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/stock-chart/stock-legend/
        var valueLegend = mainPanel.plotContainer.children.push(am5stock.StockLegend.new(root, {
            stockChart: stockChart,
            draggable: true,
        }));

        // Create Volume axis
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var volumeAxisRenderer = am5xy.AxisRendererY.new(root, {
            inside: true
        });

        volumeAxisRenderer.labels.template.set("forceHidden", true);
        volumeAxisRenderer.grid.template.set("forceHidden", true);

        var volumeValueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
            numberFormat: "#.#a",
            height: am5.percent(20),
            y: am5.percent(100),
            centerY: am5.percent(100),
            renderer: volumeAxisRenderer
        }));

        // Add series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var volumeSeries = mainPanel.series.push(am5xy.ColumnSeries.new(root, {
            name: "Volume",
            clustered: false,
            valueXField: "dt",
            valueYField: "v",
            xAxis: dateAxis,
            yAxis: volumeValueAxis,
            legendValueText: "{valueY.formatNumber('#,###.0a')}[/]"
        }));

        volumeSeries.columns.template.setAll({
            strokeOpacity: 0,
            fillOpacity: 0.5
        });

        // color columns by stock rules
        volumeSeries.columns.template.adapters.add("fill", function (fill, target) {
            var dataItem = target.dataItem;
            if (dataItem) {
                return stockChart.getVolumeColor(dataItem);
            }
            return fill;
        })


        // Set main series
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/stock-chart/#Setting_main_series
        stockChart.set("volumeSeries", volumeSeries);
        valueLegend.data.setAll([valueSeries, volumeSeries]);


        //Bullets
        addBullet("buy",0x0ecb81,'r')
        addBullet("sell_s",0xf6465d,'r')
        addBullet("sell_sl",0xf6465d,'d')
        addBullet("sell_tp",0xf6465d,'u')
        addBullet("sigB",0xfeb272,'u')
        addBullet("sigS",0xfeb272,'d')

        

        



        // Add scrollbar
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/xy-chart/scrollbars/
        var scrollbar = mainPanel.set("scrollbarX", am5xy.XYChartScrollbar.new(root, {
            orientation: "horizontal",
            height: 50
        }));
        stockChart.toolsContainer.children.push(scrollbar);

        //Cursores
        // Add cursor(s)
        // -------------------------------------------------------------------------------
        // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
        mainPanel.set("cursor", am5xy.XYCursor.new(root, {
            yAxis: valueAxis,
            xAxis: dateAxis,
        }));

        valueSeries.data.setAll(data);
        volumeSeries.data.setAll(data);

        // StopLoss y TakeProfit
        var slSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
            name: "Stop Loss",
            xAxis: dateAxis,
            yAxis: valueAxis,
            connect: false,
            stroke: am5.color(0x9a5760),
            valueYField: "SL",
            valueXField: "dt",
            valueField: "SL",
        }));
        slSeries.data.setAll(data);

        var tpSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
            name: "Stop Loss",
            xAxis: dateAxis,
            yAxis: valueAxis,
            connect: false,
            stroke: am5.color(0x318866),
            valueYField: "TP",
            valueXField: "dt",
            valueField: "TP",
        }));
        tpSeries.data.setAll(data);

        addWalletPanel()



        /// Functions

        function triangle(color,dir) {

            if (dir == 'r')
                toDraw = function (display) {
                    display.moveTo( 0, 0);
                    display.lineTo(-8,-5);
                    display.lineTo(-8, 5);
                    display.lineTo( 0, 0);
                }
            else if (dir == 'd')
                toDraw = function (display) {
                    display.moveTo( 0, 0);
                    display.lineTo( 5,-8);
                    display.lineTo(-5,-8);
                    display.lineTo( 0, 0);
                }            
            else if (dir == 'l')
                toDraw = function (display) {
                    display.moveTo( 0, 0);
                    display.lineTo( 8,-5);
                    display.lineTo( 8, 5);
                    display.lineTo( 0, 0);
                }            
            else if (dir == 'u')
                toDraw = function (display) {
                    display.moveTo( 0, 0);
                    display.lineTo(-5, 8);
                    display.lineTo( 5, 8);
                    display.lineTo( 0, 0);
                }
            return am5.Bullet.new(root, {
                locationX: 0.5,
                sprite: am5.Graphics.new(root, {
                    fill: am5.color(color),
                    stroke: am5.color(0x222222),
                    //centerY: am5.percent(50),
                    //centerX: am5.percent(50),
                    draw: toDraw
                })
            });   
        }

        function addBullet(key,color,dir)
        {
            var newSerie = mainPanel.series.push(am5xy.LineSeries.new(root, {
                calculateAggregates: true,
                xAxis: dateAxis,
                yAxis: valueAxis,
                fill: am5.color(0x0ecb81),
                valueYField: key,
                valueXField: "dt",
            }));


            // Add bullets
            newSerie.bullets.push(function () {
                return triangle(color,dir)
            });
            newSerie.data.setAll(data);
        }


        function addWalletPanel() {
            var subPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
                wheelY: "zoomX",
                panX: true,
                panY: true,
                height: am5.percent(35),
            }));

            var subValueLegend = subPanel.plotContainer.children.push(am5stock.StockLegend.new(root, {
                stockChart: stockChart,
                draggable: true,

            }));

            // Create axes
            // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
            var subValueAxis = subPanel.yAxes.push(am5xy.ValueAxis.new(root, {
                renderer: am5xy.AxisRendererY.new(root, {
                    inside: false,
                }),
                numberFormat: "#,###.00",
            }));

            subValueAxis.get("renderer").labels.template.setAll({
            });



            // Create series Sub Panel ----------------------------------------------------------------------
            // https://www.amcharts.com/docs/v5/charts/xy-chart/series/

            var holdSeries = subPanel.series.push(am5xy.LineSeries.new(root, {
                name: "USD Hold",
                xAxis: dateAxis,
                yAxis: subValueAxis,
                stroke: am5.color(0x888888),
                valueYField: "usdH",
                valueXField: "dt",
                valueField: "usdH",
                legendValueText: "{value}",
                legendRangeValueText: ""
            }));

            var walletSeries = subPanel.series.push(am5xy.LineSeries.new(root, {
                name: "USD Capital",
                xAxis: dateAxis,
                yAxis: subValueAxis,
                stroke: am5.color(0x6edff6),
                valueYField: "usdW",
                valueXField: "dt",
                valueField: "usdW",
                legendValueText: "{value}",
                legendRangeValueText: ""
            }));


            stockChart.set("holdSeries", holdSeries);
            stockChart.set("walletSeries", walletSeries);
            subValueLegend.data.setAll([holdSeries, walletSeries]);

            //Cursor
            subPanel.set("cursor", am5xy.XYCursor.new(root, {
                yAxis: subValueAxis,
                xAxis: dateAxis,
            }));

            holdSeries.data.setAll(data);
            walletSeries.data.setAll(data);
        }


    };

    function infoDraw(bt)
    {
        var div = $('#resumen-tab-pane');
        div.find('#general').html('<h6 class="text-info">General</h6>');
        div.find('#operaciones').html('<h6 class="text-info">Operaciones</h6>');
        div.find('#indicadores').html('<h6 class="text-info">Indicadores</h6>');
        for (const items of bt.brief) {
            cls = '';
            if (items[3])
                cls = items[3]
            var html = '<div class="row pt-2">';
            html += '<div class="col-6">'+items[1]+'</div>';
            html += '<div class="col-6 '+cls+'">'+items[2]+'</div></div>'
            html += '</div>';
            div.find('#'+items[0]).append(html);
        } 
        

        var tbody = $('#ordenes-tab-pane table tbody');
        tbody.html('')
        for (const order of bt.orders) {
            var cls = (order[2]==0?'green':'red');
            var tr = '<tr class="'+cls+'">';
            tr += '<td>'+order[0]+'</td>';
            tr += '<td>'+order[1]+'</td>';
            var side = bt.order_side[order[2]]
            if (order[5] != 0)
                side += ' '+bt.order_flag[order[5]]
            tr += '<td>'+side+'</td>';
            tr += '<td>'+order[3]+'</td>';
            tr += '<td>'+order[4]+'</td>';
            tr += '<td>'+to_dec(order[3]*order[4],2)+'</td>';
            tr += '</tr>';
            tbody.append(tr);
        } 

        var tbody = $('#trades-tab-pane table tbody');
        tbody.html('')
        for (const order of bt.trades) {
            var cls = (order[7]>0?'green':'red');
            var tr = '<tr class="'+cls+'">';
            tr += '<td>'+order[0]+'</td>';
            tr += '<td>'+order[1]+'</td>';
            tr += '<td>'+order[2]+'</td>';
            tr += '<td>'+order[3]+'</td>';
            tr += '<td>'+order[4]+'</td>';
            tr += '<td>'+(order[5]>0?bt.order_flag[order[5]]:'')+'</td>';
            tr += '<td>'+order[6]+'</td>';
            tr += '<td>'+to_dec(order[7],2)+'</td>';
            tr += '<td>'+to_dec(order[8],2)+'</td>';
            tr += '</tr>';
            tbody.append(tr);
        } 
        bootstrapFormat();
    }

</script>

<div class="row">
    <h5>Resultados</h5>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="resumen">
          <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumen-tab-pane" type="button" role="tab" aria-controls="resumen-tab-pane" aria-selected="true">Resumen</button>
        </li>
        <li class="nav-item" role="resumen">
          <button class="nav-link" id="chardiv-tab" data-bs-toggle="tab" data-bs-target="#chardiv-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">Grafico</button>
        </li>
        <li class="nav-item" role="resumen">
          <button class="nav-link" id="ordenes-tab" data-bs-toggle="tab" data-bs-target="#ordenes-tab-pane" type="button" role="tab" aria-controls="ordenes-tab-pane" aria-selected="false">Ordenes</button>
        </li>
        <li class="nav-item" role="resumen">
            <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades-tab-pane" type="button" role="tab" aria-controls="trades-tab-pane" aria-selected="false">Operaciones</button>
          </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="resumen-tab-pane" role="tabpanel" aria-labelledby="resumen-tab" tabindex="0" >
            <div class="row pt-4">
                <div class="col-6" id="general" style="font-size: 0.8em;" ></div>
                <div class="col-3" id="operaciones" style="font-size: 0.8em;" ></div>
                <div class="col-3" id="indicadores" style="font-size: 0.8em;" ></div>
            </div>
            
        </div>
        <div class="tab-pane fade" id="chardiv-tab-pane" role="tabpanel" aria-labelledby="chardiv-tab" tabindex="0"></div>
        <div class="tab-pane fade" id="ordenes-tab-pane" role="tabpanel" aria-labelledby="ordenes-tab" tabindex="0">
            <table class="table-dg table-trade-info">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Symbol</th>
                        <th>Operacion</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>USD</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
        <div class="tab-pane fade" id="trades-tab-pane" role="tabpanel" aria-labelledby="trades-tab" tabindex="0">
            <table class="table-dg table-trade-info">
                <thead>
                    <tr>
                        <th>Compra Fecha</th>
                        <th>Compra Precio</th>
                        <th>Cantidad</th>
                        <th>Venta Fecha</th>
                        <th>Venta Precio</th>
                        <th>Accion</th>
                        <th>Duracion (Dias)</th>
                        <th>Resultado USD</th>
                        <th>Resultado %</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
      </div>
</div>
